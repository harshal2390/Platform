<% layout("layouts/boilerplate") %>

<div class="row mt-3">
  <div class="col-8 offset-2 mt-2">
    <h3 class="mt-2"><b><%= project.title %></b></h3>
  </div>

  <div class="card col-6 offset-3 show-card project-card">
    <img
      src="<%= project.image?.url || '/images/default.png' %>"
      class="card-img-top show-img"
      alt="<%= project.title %>"
    />

    <div class="card-body">
      <p class="card-text">
        Posted by
        <i><b><%= project.employer?.name || 'Unknown Employer' %></b></i>
      </p>
      <p class="card-text"><%= project.description %></p>
      <p class="card-text">
        <strong>Budget:</strong> <%= project.currency %> <%= project.budgetMin
        %> - <%= project.budgetMax %>
      </p>
      <p class="card-text">
        <strong>Timeline:</strong> <%= project.timeline %>
      </p>
      <p class="card-text">
        <strong>Skills:</strong> <%= project.skills.join(", ") %>
      </p>
      <p class="card-text"><strong>Status:</strong> <%= project.status %></p>
    </div>
  </div>

  <!-- Employer Buttons -->
  <% if (currUser && currUser._id.toString() ===
  project.employer._id.toString()) { %>
  <div class="btns mt-3 col-6 offset-3 d-flex justify-content-between">
    <a href="/projects/<%= project._id %>/edit" class="btn btn-dark col-5"
      >Edit</a
    >

    <form
      action="/projects/<%= project._id %>?_method=DELETE"
      method="post"
      class="col-5"
    >
      <button class="btn btn-danger w-100" type="submit">Delete</button>
    </form>
  </div>
  <% } %>

  <!-- Freelancer Apply Form -->
  <% if (currUser && currUser.role === "freelancer" && currUser._id.toString()
  !== project.employer._id.toString()) { %>
  <div class="apply-section mt-4 col-6 offset-3">
    <% if (hasApplied) { %>
    <!-- Already applied -->
    <button class="btn btn-secondary w-100" disabled>âœ… Already Applied</button>
    <% } else { %>
    <!-- Show Apply button and form -->
    <button id="showApplyForm" class="btn btn-success w-100">
      Apply to this Project
    </button>

    <form
      id="applyForm"
      action="/projects/<%= project._id %>/apply"
      method="POST"
      class="mt-3 d-none"
    >
      <div class="mb-3">
        <label for="bidAmount" class="form-label"
          >Bid Amount (<%= project.currency %>)</label
        >
        <input type="number" class="form-control" name="bidAmount" required />
      </div>

      <div class="mb-3">
        <label for="proposedTimeline" class="form-label"
          >Proposed Timeline</label
        >
        <input
          type="text"
          class="form-control"
          name="proposedTimeline"
          placeholder="e.g. 2 weeks"
          required
        />
      </div>

      <div class="mb-3">
        <label for="coverLetter" class="form-label"
          >Cover Letter / Explanation</label
        >
        <textarea
          class="form-control"
          name="coverLetter"
          rows="4"
          placeholder="Why should the employer hire you?"
          required
        ></textarea>
      </div>

      <button type="submit" class="btn btn-primary w-100">
        Submit Application
      </button>
    </form>
    <% } %>
  </div>

  <% if (!hasApplied) { %>
  <script>
    const showBtn = document.getElementById("showApplyForm");
    const form = document.getElementById("applyForm");

    if (showBtn && form) {
      showBtn.addEventListener("click", () => {
        form.classList.toggle("d-none");
        showBtn.classList.toggle("d-none");
      });
    }
  </script>
  <% } %> <% } %>
</div>
