<% layout("layouts/boilerplate") %>

<!-- jQuery & Bootstrap JS for modal -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<div class="container mt-5">
  <h2 class="fw-bold mb-4 text-primary">📂 Ongoing Contracts</h2>

  <% if (contracts.length === 0) { %>
  <div class="alert alert-info text-center shadow-sm p-3 rounded">
    🚀 You don’t have any ongoing contracts yet.
  </div>
  <% } else { %>
  <div class="row g-4">
    <% contracts.forEach(contract => { %>
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm border-0 h-100 rounded-4">
        <div class="card-body d-flex flex-column">
          <!-- Project -->
          <h5 class="card-title mb-2 text-dark fw-bold">
            <a
              href="/projects/<%= contract.project._id %>"
              class="text-decoration-none text-primary"
            >
              <%= contract.project.title %>
            </a>
          </h5>

          <!-- Freelancer -->
          <p class="mb-2 text-muted">
            👤 <strong><%= contract.freelancer?.name %></strong><br />
            <small><%= contract.freelancer?.email %></small>
          </p>

          <!-- Budget Info -->
          <p class="mb-1">
            💰 <strong>Budget:</strong>
            <%= contract.project.currency %> <%= contract.project.budgetMin %> -
            <%= contract.project.currency %> <%= contract.project.budgetMax %>
          </p>

          <!-- Agreed Amount -->
          <p class="mb-3">
            🤝 <strong>Agreed:</strong> <%= contract.currency %> <%=
            contract.amount %>
          </p>

          <!-- Status -->
          <div class="mb-3">
            <% if(contract.status === "pending_payment") { %>
            <span class="badge bg-warning text-dark px-3 py-2 rounded-pill"
              >⏳ Pending Payment</span
            >
            <% } else if(contract.status === "in_progress") { %>
            <span class="badge bg-primary px-3 py-2 rounded-pill"
              >🚀 In Progress</span
            >
            <% } else if(contract.status === "completed") { %>
            <span class="badge bg-success px-3 py-2 rounded-pill"
              >✅ Completed</span
            >
            <% } else { %>
            <span class="badge bg-danger px-3 py-2 rounded-pill"
              >❌ Cancelled</span
            >
            <% } %>
          </div>

          <!-- Actions -->
          <div class="mt-auto">
            <% if(contract.status === "pending_payment") { %>
            <button
              class="btn btn-warning w-100 rounded-pill mb-2"
              onclick="showCardModal('<%= contract._id %>', '<%= contract.amount %>')"
            >
              💰 Fund Escrow
            </button>
            <% } %> <% if(contract.status === "in_progress") { %>
            <button
              class="btn btn-success w-100 rounded-pill mb-2"
              onclick="releasePayment('<%= contract._id %>')"
            >
              💵 Release Payment
            </button>
            <% } %>

            <a
              href="/chat/<%= contract._id %>"
              class="btn btn-outline-primary w-100 rounded-pill"
            >
              💬 Chat with <%= contract.freelancer?.name %>
            </a>
          </div>
        </div>
      </div>
    </div>
    <% }) %>
  </div>
  <% } %>
</div>

<!-- Modal for Stripe Card -->
<div class="modal fade" id="cardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <h5>Enter Card Details</h5>
      <div id="card-element" class="mb-3"></div>
      <button id="payBtn" class="btn btn-primary w-100 mt-3">Pay</button>
      <div id="payment-status" class="mt-2 text-muted small"></div>
    </div>
  </div>
</div>

<!-- Stripe JS -->
<script src="https://js.stripe.com/v3/"></script>

<script>
  // Stripe setup
  const stripe = Stripe("<%= process.env.STRIPE_PUBLISHABLE_KEY %>");
  const elements = stripe.elements();
  const card = elements.create("card");
  card.mount("#card-element");

  let currentContractId = null;

  function showCardModal(contractId, amount) {
    currentContractId = contractId;
    document.getElementById("payment-status").innerText = "";
    $("#cardModal").modal("show");
  }

  document.getElementById("payBtn").addEventListener("click", async () => {
    if (!currentContractId) return;

    const payBtn = document.getElementById("payBtn");
    const statusEl = document.getElementById("payment-status");

    payBtn.disabled = true;
    statusEl.innerText = "⏳ Processing payment...";

    try {
      const res = await fetch(`/payment/create-escrow/${currentContractId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });

      const data = await res.json();
      if (!data.clientSecret) {
        statusEl.innerText = "❌ Failed to create escrow";
        payBtn.disabled = false;
        return;
      }

      const { error, paymentIntent } = await stripe.confirmCardPayment(
        data.clientSecret,
        {
          payment_method: { card, billing_details: { name: "Employer" } },
        }
      );

      if (error) {
        statusEl.innerText = "❌ Payment failed: " + error.message;
        payBtn.disabled = false;
      } else if (paymentIntent.status === "succeeded") {
        statusEl.innerText = "✅ Payment funded successfully!";
        setTimeout(() => {
          $("#cardModal").modal("hide");
          location.reload();
        }, 1200);
      }
    } catch (err) {
      console.error(err);
      statusEl.innerText = "❌ Something went wrong while funding escrow";
      payBtn.disabled = false;
    }
  });

  async function releasePayment(contractId) {
    try {
      const res = await fetch(`/payment/release/${contractId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
      });
      const data = await res.json();
      if (data.success) {
        alert("💵 Payment released to freelancer!");
        location.reload();
      } else {
        alert("❌ Failed to release payment");
      }
    } catch (err) {
      console.error(err);
      alert("Something went wrong while releasing payment");
    }
  }
</script>
